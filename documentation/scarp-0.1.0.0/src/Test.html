<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Test</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-2"></a><span>
</span><a name="line-3"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Math</span><span class="hs-operator">.</span><span class="hs-identifier">LinearAlgebra</span><span class="hs-operator">.</span><span class="hs-identifier">Sparse</span><span class="hs-operator">.</span><span class="hs-identifier">Matrix</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">S</span><span>
</span><a name="line-4"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Math</span><span class="hs-operator">.</span><span class="hs-identifier">LinearAlgebra</span><span class="hs-operator">.</span><span class="hs-identifier">Sparse</span><span class="hs-operator">.</span><span class="hs-identifier">Vector</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Sv</span><span>
</span><a name="line-5"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Numeric</span><span class="hs-operator">.</span><span class="hs-identifier">LinearAlgebra</span><span>
</span><a name="line-6"></a><span>
</span><a name="line-7"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span><span>
</span><a name="line-8"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Maybe</span><span>
</span><a name="line-9"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span>
</span><a name="line-10"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Parallel</span><span class="hs-operator">.</span><span class="hs-identifier">Strategies</span><span>
</span><a name="line-11"></a><span>
</span><a name="line-12"></a><span class="hs-keyword">import</span><span> </span><a href="Settings.html"><span class="hs-identifier">Settings</span></a><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span> </span><a href="Helpers.html"><span class="hs-identifier">Helpers</span></a><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span> </span><a href="NNLS.html"><span class="hs-identifier">NNLS</span></a><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><a href="Discretization.html"><span class="hs-identifier">Discretization</span></a><span> </span><span>
</span><a name="line-16"></a><span>
</span><a name="line-17"></a><span class="hs-keyword">type</span><span> </span><a name="PiResampler"><a href="Test.html#PiResampler"><span class="hs-identifier">PiResampler</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">]</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><a href="Helpers.html#HChoice3"><span class="hs-identifier hs-type">HChoice3</span></a><span class="hs-special">]</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SparseVector</span><span> </span><span class="hs-identifier hs-type">Double</span><span>
</span><a name="line-18"></a><span>
</span><a name="line-19"></a><span class="hs-identifier">maxSteps</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-20"></a><a name="maxSteps"><a href="Test.html#maxSteps"><span class="hs-identifier">maxSteps</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">10000</span><span>
</span><a name="line-21"></a><span>
</span><a name="line-22"></a><span class="hs-identifier">calculateTestStatistic</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Double</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SparseMatrix</span><span> </span><span class="hs-identifier hs-type">Double</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Test.html#PiResampler"><span class="hs-identifier hs-type">PiResampler</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="hs-special">[</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">]</span><span class="hs-special">]</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><a href="Helpers.html#HChoice3"><span class="hs-identifier hs-type">HChoice3</span></a><span class="hs-special">]</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Double</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Double</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span>
</span><a name="line-23"></a><a name="calculateTestStatistic"><a href="Test.html#calculateTestStatistic"><span class="hs-identifier">calculateTestStatistic</span></a></a><span> </span><a name="local-6989586621679087275"><a href="#local-6989586621679087275"><span class="hs-identifier">fixedTau</span></a></a><span> </span><a name="local-6989586621679087276"><a href="#local-6989586621679087276"><span class="hs-identifier">smA</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679087277"><a href="#local-6989586621679087277"><span class="hs-identifier">bidcs</span></a></a><span> </span><a name="local-6989586621679087278"><a href="#local-6989586621679087278"><span class="hs-identifier">cs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679087300"><span class="hs-identifier hs-var">eval</span></a><span> </span><span class="hs-special">(</span><a href="Discretization.html#getPiFromChoices"><span class="hs-identifier hs-var">getPiFromChoices</span></a><span> </span><a href="#local-6989586621679087278"><span class="hs-identifier hs-var">cs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679087296"><span class="hs-identifier hs-var">dnureal</span></a><span class="hs-special">,</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">sort</span><span> </span><a href="#local-6989586621679087302"><span class="hs-identifier hs-var">js</span></a><span class="hs-special">,</span><span> </span><a href="Test.html#maxSteps"><span class="hs-identifier hs-var">maxSteps</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679087295"><span class="hs-identifier hs-var">remainingSteps</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="Test.html#maxSteps"><span class="hs-identifier hs-var">maxSteps</span></a><span class="hs-glyph">-</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679087303"><span class="hs-identifier hs-var">steps</span></a><span class="hs-special">)</span><span> </span><span>
</span><a name="line-24"></a><span>	</span><span class="hs-keyword">where</span><span>
</span><a name="line-25"></a><span>		</span><span class="hs-identifier">nPeriods</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">length</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">head</span><span> </span><span class="hs-identifier">bidcs</span><span class="hs-special">)</span><span>
</span><a name="line-26"></a><span>		</span><span class="hs-identifier">nSample</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">head</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679087280"><a href="#local-6989586621679087280"><span class="hs-identifier">map</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">map</span><span> </span><span class="hs-identifier">length</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">bidcs</span><span class="hs-special">)</span><span>
</span><a name="line-27"></a><span>		</span><span class="hs-identifier">idx0</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">n</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-number">0</span><span class="hs-glyph">..</span><span class="hs-special">(</span><span class="hs-identifier hs-var">n</span><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">nSample</span><span> </span><span>
</span><a name="line-28"></a><span>		</span><span>
</span><a name="line-29"></a><span>		</span><span class="hs-identifier">s2d</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">fromList</span><span> </span><a name="local-6989586621679087282"><a href="#local-6989586621679087282"><span class="hs-operator">.</span></a></a><span> </span><span class="hs-identifier">Sv</span><span class="hs-operator">.</span><span class="hs-identifier hs-var">fillVec</span><span> </span><span>
</span><a name="line-30"></a><span>		</span><span class="hs-special">(</span><span class="hs-identifier">smH</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">dmH</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">S</span><a name="local-6989586621679087283"><a href="#local-6989586621679087283"><span class="hs-operator">.</span></a></a><span class="hs-identifier">trans</span><span> </span><span class="hs-identifier">smA</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">mul</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">smA</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fromLists</span><span> </span><a href="#local-6989586621679087276"><span class="hs-operator hs-var">.</span></a><span> </span><span class="hs-identifier">S</span><span class="hs-operator">.</span><span class="hs-identifier hs-var">fillMx</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">smH</span><span class="hs-special">)</span><span>
</span><a name="line-31"></a><span>		</span><span class="hs-special">(</span><span class="hs-identifier">sconstv</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">dconstv</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">c</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a name="local-6989586621679087286"><a href="#local-6989586621679087286"><span class="hs-identifier">S</span><span class="hs-operator">.</span></a></a><span class="hs-identifier">row</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier">sparseMx</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">replicate</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">height</span><span> </span><span class="hs-identifier hs-var">smH</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">c</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679087283"><span class="hs-identifier hs-var">Sv</span><span class="hs-operator hs-var">.</span></a><span class="hs-identifier">SparseVector</span><span> </span><span class="hs-identifier hs-type">Double</span><span class="hs-special">,</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier hs-type">c</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">fromList</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">replicate</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">height</span><span> </span><span class="hs-identifier hs-var">smH</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">c</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Double</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-32"></a><span>		</span><span class="hs-special">(</span><span class="hs-identifier">n'</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">h'</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">fromIntegral</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">minimum</span><span> </span><span class="hs-identifier">nSample</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fromIntegral</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">height</span><span> </span><span class="hs-identifier hs-var">smH</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Double</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">Double</span><span class="hs-special">)</span><span> </span><span>
</span><a name="line-33"></a><span>		</span><span class="hs-identifier">tauN</span><span> </span><span class="hs-glyph">=</span><span>  </span><span class="hs-identifier">fromMaybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">sconstv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">sqrt</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679087285"><span class="hs-identifier hs-var">log</span></a><span> </span><a href="#local-6989586621679087285"><span class="hs-identifier hs-var">n'</span></a><span> </span><span class="hs-operator">/</span><span> </span><span class="hs-identifier hs-var">n'</span><span class="hs-special">)</span><span> </span><span class="hs-operator">/</span><span> </span><span class="hs-identifier hs-var">h'</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">dataTau</span><span> </span><span class="hs-identifier">nPeriods</span><span> </span><a href="Test.html#dataTau"><span class="hs-identifier hs-var">smA</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">getPiFromChoices</span><span> </span><a href="Discretization.html#getPiFromChoices"><span class="hs-identifier hs-var">cs</span></a><span class="hs-special">)</span><span> </span><a href="Discretization.html#getPiFromChoices"><span class="hs-identifier hs-var">fixedTau</span></a><span class="hs-special">)</span><span>
</span><a name="line-34"></a><span>		</span><span class="hs-identifier">svb</span><span> </span><span class="hs-identifier">p</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">p</span><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">smA</span><span> </span><span class="hs-special">`</span><a name="local-6989586621679087307"><a href="#local-6989586621679087307"><span class="hs-identifier">S</span></a></a><span class="hs-operator">.</span><span class="hs-identifier">mulMV</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">tauN</span><span class="hs-special">)</span><span>
</span><a name="line-35"></a><span>		</span><span class="hs-comment">-- f = -A.T b (where b should be positive since gradient depends on choice of tau_n, might be strictly positive)</span><span>
</span><a name="line-36"></a><span>		</span><span class="hs-special">(</span><span class="hs-identifier">svf</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">dvf</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679087291"><a href="#local-6989586621679087291"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-glyph">-</span><a name="local-6989586621679087292"><a href="#local-6989586621679087292"><span class="hs-identifier">S</span><span class="hs-operator">.</span></a></a><span class="hs-identifier">trans</span><span> </span><span class="hs-identifier">smA</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">mulMV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679087276"><span class="hs-identifier hs-var">svb</span></a><span> </span><span class="hs-identifier hs-var">p</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">s2d</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">svf</span><span class="hs-special">)</span><span> </span><span>
</span><a name="line-37"></a><span>		</span><span class="hs-identifier">dvdinv</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">cmap</span><span> </span><span class="hs-special">(</span><span class="hs-number">1</span><a name="local-6989586621679087293"><a href="#local-6989586621679087293"><span class="hs-operator">/</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">dmH</span><span> </span><span class="hs-operator hs-var">#&gt;</span><span> </span><span class="hs-identifier">dconstv</span><span> </span><span class="hs-number">1.0</span><span class="hs-special">)</span><span>
</span><a name="line-38"></a><span>		</span><span class="hs-identifier">optimize</span><span> </span><span class="hs-identifier">p</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679087294"><a href="#local-6989586621679087294"><span class="hs-identifier">s</span></a></a><span class="hs-special">,</span><a name="local-6989586621679087294"><a href="#local-6989586621679087294"><span class="hs-identifier">nu</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">s</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">nu</span><span> </span><a name="local-6989586621679087311"><a href="#local-6989586621679087311"><span class="hs-operator">+</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">fromList</span><span> </span><a href="#local-6989586621679087311"><span class="hs-operator hs-var">.</span></a><span> </span><span class="hs-identifier">Sv</span><span class="hs-operator">.</span><span class="hs-identifier hs-var">fillVec</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">tauN</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">stepwiseOptimizer</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">stepLandweber</span><span> </span><a href="NNLS.html#stepLandweber"><span class="hs-identifier hs-var">dmH</span></a><span> </span><a href="NNLS.html#stepLandweber"><span class="hs-identifier hs-var">dvdinv</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">dvf</span><span> </span><a href="#local-6989586621679087284"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679087293"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">maxSteps</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">dconstv</span><span> </span><span class="hs-number">0.0</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">StepInfo</span><span>
</span><a name="line-39"></a><span>
</span><a name="line-40"></a><span>		</span><span class="hs-special">(</span><span class="hs-identifier">remainingSteps</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679087295"><a href="#local-6989586621679087295"><span class="hs-identifier">dnureal</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">optimize</span><span> </span><a name="local-6989586621679087296"><a href="#local-6989586621679087296"><span class="hs-operator">$</span></a></a><span> </span><span class="hs-identifier">getPiFromChoices</span><span> </span><a href="Discretization.html#getPiFromChoices"><span class="hs-identifier hs-var">cs</span></a><span> </span><span>
</span><a name="line-41"></a><span>		</span><span class="hs-identifier">sumnu</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">dconstv</span><span> </span><span class="hs-number">1.0</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">Numeric</span><a href="#local-6989586621679087286"><span class="hs-operator hs-var">.</span></a><span class="hs-identifier">LinearAlgebra</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">dot</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">dnureal</span><span>
</span><a name="line-42"></a><span>		</span><span class="hs-identifier">seta</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">smA</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">S</span><span class="hs-operator">.</span><span class="hs-identifier">mulMV</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">sparseList</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">toList</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">dnureal</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">SparseVector</span><span> </span><span class="hs-identifier">Double</span><span> </span><span>
</span><a name="line-43"></a><span>		</span><span class="hs-identifier">piTauNs</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">getPiFromChoices</span><span> </span><a href="Discretization.html#getPiFromChoices"><span class="hs-operator hs-var">.</span></a><span> </span><span class="hs-identifier">reshuffleChoices</span><span> </span><a href="Discretization.html#reshuffleChoices"><span class="hs-identifier hs-var">cs</span></a><span class="hs-special">)</span><span> </span><a href="Discretization.html#reshuffleChoices"><span class="hs-identifier hs-var">bidcs</span></a><span>
</span><a name="line-44"></a><span>		</span><span class="hs-identifier">eval</span><span> </span><span class="hs-identifier">r</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">piTauN</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">res</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">steps</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679087314"><a href="#local-6989586621679087314"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-keyword">in</span><span>  </span><span class="hs-special">(</span><span class="hs-identifier">fctJ</span><span> </span><span class="hs-identifier">nPeriods</span><span> </span><a href="NNLS.html#fctJ"><span class="hs-identifier hs-var">dmH</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679087279"><span class="hs-identifier hs-var">s2d</span></a><span> </span><span class="hs-identifier">piTauN</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">s2d</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-glyph">-</span><a href="#local-6989586621679087313"><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span></a><span class="hs-identifier">trans</span><span> </span><span class="hs-identifier">smA</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">mulMV</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">piTauN</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">res</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">steps</span><span class="hs-special">)</span><span>
</span><a name="line-45"></a><span>		</span><span class="hs-identifier">optimizePerPiTauN</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679087301"><a href="#local-6989586621679087301"><span class="hs-identifier">eval</span></a></a><span> </span><a name="local-6989586621679087301"><a href="#local-6989586621679087301"><span class="hs-operator">.</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">piTauN</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679087316"><a href="#local-6989586621679087316"><span class="hs-identifier">steps</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">res</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">optimize</span><span> </span><span class="hs-identifier">piTauN</span><span> </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">piTauN</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">res</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">steps</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier">seta</span><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-identifier">getPiFromChoices</span><span> </span><a href="Discretization.html#getPiFromChoices"><span class="hs-identifier hs-var">cs</span></a><span class="hs-special">)</span><span> </span><a href="Discretization.html#getPiFromChoices"><span class="hs-operator hs-var">+</span></a><span class="hs-special">)</span><span>
</span><a name="line-46"></a><span>
</span><a name="line-47"></a><span>		</span><span class="hs-special">(</span><span class="hs-identifier">js</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">steps</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">unzip</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679087303"><a href="#local-6989586621679087303"><span class="hs-identifier">map</span></a></a><span> </span><span class="hs-identifier">optimizePerPiTauN</span><span> </span><a href="#local-6989586621679087301"><span class="hs-identifier hs-var">piTauNs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier">using</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">parList</span><span> </span><span class="hs-identifier">rdeepseq</span><span class="hs-special">)</span><span>
</span><a name="line-48"></a><span>
</span><a name="line-49"></a><span class="hs-comment">--- can only be done for worst case</span><span>
</span><a name="line-50"></a><span class="hs-identifier">dataTau</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">SparseMatrix</span><span> </span><span class="hs-identifier hs-type">Double</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Sv</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">SparseVector</span><span> </span><span class="hs-identifier hs-type">Double</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Double</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Sv</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">SparseVector</span><span> </span><span class="hs-identifier hs-type">Double</span><span class="hs-special">)</span><span>
</span><a name="line-51"></a><a name="dataTau"><a href="Test.html#dataTau"><span class="hs-identifier">dataTau</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-52"></a><span class="hs-identifier">dataTau</span><span> </span><a name="local-6989586621679087319"><a href="#local-6989586621679087319"><span class="hs-identifier">nPeriods</span></a></a><span> </span><a name="local-6989586621679087320"><a href="#local-6989586621679087320"><span class="hs-identifier">smA</span></a></a><span> </span><a name="local-6989586621679087321"><a href="#local-6989586621679087321"><span class="hs-identifier">svPi</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679087322"><a href="#local-6989586621679087322"><span class="hs-identifier">fixed</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679087324"><span class="hs-identifier hs-var">tau'</span></a><span> </span><span>
</span><a name="line-53"></a><span>	</span><span class="hs-keyword">where</span><span> </span><span>
</span><a name="line-54"></a><span>		</span><span class="hs-identifier">tau</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Sv</span><span class="hs-operator">.</span><span class="hs-identifier">sparseList</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">toList</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">head</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">toRows</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">tr</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">linearSolveSVD</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromLists</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">S</span><span class="hs-operator">.</span><span class="hs-identifier hs-var">fillMx</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">smA</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier hs-var">tr</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">fromLists</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">return</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">Sv</span><span class="hs-operator">.</span><span class="hs-identifier">fillVec</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">svPi</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">0.01</span><span class="hs-special">)</span><span>
</span><a name="line-55"></a><span>		</span><span class="hs-identifier">tau'</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">S</span><span class="hs-operator">.</span><span class="hs-identifier">row</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier">sparseMx</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">replicate</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">width</span><span> </span><span class="hs-identifier hs-var">smA</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">fixed</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Sv</span><a href="#local-6989586621679087322"><span class="hs-operator hs-var">.</span></a><span class="hs-identifier">SparseVector</span><span> </span><span class="hs-identifier hs-type">Double</span><span>
</span><a name="line-56"></a><span>
</span><a name="line-57"></a><span class="hs-identifier">writeEmpDist</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Double</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Double</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-58"></a><a name="writeEmpDist"><a href="Test.html#writeEmpDist"><span class="hs-identifier">writeEmpDist</span></a></a><span> </span><a name="local-6989586621679087844"><a href="#local-6989586621679087844"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679087845"><a href="#local-6989586621679087845"><span class="hs-identifier">p</span></a></a><span> </span><a name="local-6989586621679087846"><a href="#local-6989586621679087846"><span class="hs-identifier">jopt</span></a></a><span> </span><a name="local-6989586621679087847"><a href="#local-6989586621679087847"><span class="hs-identifier">js</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span>
</span><a name="line-59"></a><span>		</span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">empDist</span><span> </span><span class="hs-identifier">x</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679087848"><a href="#local-6989586621679087848"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">realToFrac</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">sum</span><span> </span><span class="hs-identifier hs-var">xs</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">/</span><span> </span><span class="hs-identifier">genericLength</span><span> </span><span class="hs-identifier hs-var">xs</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">x0</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">x0</span><span> </span><span class="hs-operator">&lt;=</span><span> </span><a name="local-6989586621679087851"><a href="#local-6989586621679087851"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span>
</span><a name="line-60"></a><span>		</span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">support</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">toList</span><span> </span><a name="local-6989586621679087852"><a href="#local-6989586621679087852"><span class="hs-operator">$</span></a></a><span> </span><span class="hs-identifier">linspace</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">length</span><span> </span><span class="hs-identifier hs-var">js</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">minimum</span><span> </span><span class="hs-identifier">js</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">maximum</span><span> </span><span class="hs-identifier">js</span><span class="hs-special">)</span><span>
</span><a name="line-61"></a><span>		</span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">empdistgraph</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679087853"><a href="#local-6989586621679087853"><span class="hs-identifier">map</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679087853"><a href="#local-6989586621679087853"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">x</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">empDist</span><span> </span><span class="hs-identifier">x</span><span> </span><span class="hs-identifier">js</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">support</span><span> </span><span>
</span><a name="line-62"></a><span>		</span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">exportstring</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679087855"><a href="#local-6989586621679087855"><span class="hs-identifier">Control</span><span class="hs-operator">.</span></a></a><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier hs-var">join</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-identifier hs-var">x</span><span class="hs-special">,</span><span class="hs-identifier hs-var">y</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">show</span><span> </span><span class="hs-identifier">x</span><span> </span><span class="hs-operator">++</span><span> </span><span class="hs-string">&quot; &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier">show</span><span> </span><span class="hs-identifier hs-var">y</span><span> </span><span class="hs-operator">++</span><span> </span><span class="hs-string">&quot; &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier">show</span><span> </span><span class="hs-identifier">jopt</span><span> </span><span class="hs-operator">++</span><span> </span><span class="hs-string">&quot; &quot;</span><span> </span><span class="hs-operator">++</span><span> </span><span class="hs-identifier">show</span><span> </span><span class="hs-identifier hs-var">y</span><span> </span><span class="hs-operator">++</span><span> </span><span class="hs-string">&quot;\n&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">empdistgraph</span><span>
</span><a name="line-63"></a><span>		</span><span class="hs-identifier">writeFile</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">resultsPrefix</span><span> </span><a href="Settings.html#resultsPrefix"><span class="hs-operator hs-var">++</span></a><span> </span><span class="hs-string">&quot;empdist.&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier">show</span><span> </span><span class="hs-identifier">n</span><span> </span><span class="hs-operator">++</span><span>  </span><span class="hs-string">&quot;.&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier">show</span><span> </span><span class="hs-identifier">p</span><span> </span><span class="hs-operator">++</span><span> </span><span class="hs-string">&quot;.csv&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">exportstring</span><span>
</span><a name="line-64"></a><span>
</span><a name="line-65"></a><span>
</span><a name="line-66"></a><span class="hs-comment">-- depreviated:</span><span>
</span><a name="line-67"></a><span class="hs-comment">-- head . toRows . tr $ linearSolveSVD ((fromLists . S.fillMx) smA) ((tr . fromLists . return . Sv.fillVec) (svPi idx0 cs))</span><span>
</span><a name="line-68"></a><span class="hs-comment">--	where</span><span>
</span><a name="line-69"></a><span class="hs-comment">--		ncpp = floor $ (fromIntegral . fst . S.dims $ smA) / fromIntegral nPeriods</span><span>
</span><a name="line-70"></a><span class="hs-comment">--		tblocksPi = chunksOf ncpp (Sv.fillVec svPi)</span><span>
</span><a name="line-71"></a><span class="hs-comment">--		tblocksA = chunksOf ncpp (S.fillMx smA)</span><span>
</span><a name="line-72"></a><span class="hs-comment">--		subBlocks = zipWith (\a pi -&gt; filter (\(i,ai,pii) -&gt; (not . and) ((pii==0):map (==0) ai)) (zip3 [1..] a pi)) tblocksA tblocksPi</span><span>
</span><a name="line-73"></a><span class="hs-comment">--		sols = zipWith linearSolveSVD (map (fromLists . map snd3) subBlocks) (map (tr . fromLists . return . map trd3) subBlocks)</span><span>
</span><a name="line-74"></a><span class="hs-comment">--		assoclists = zipWith (\idcs sol -&gt; zip (map ((,) 1) idcs) (take (length idcs) sol)) (map (map fst3) subBlocks) (map (head . toLists . tr) sols)</span><span>
</span><a name="line-75"></a><span class="hs-comment">--		-- Just (Sv.sparseList (join (map (head . S.fillMx . fromAssocListWithSize (1, ncpp)) assoclists)))</span><span>
</span><a name="line-76"></a></pre></body></html>